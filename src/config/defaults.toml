# These are loaded first, then overridden by user config.
poll_interval_ms = 500
capture_lines = 200
show_detached_sessions = true
debug_mode = false
truncate_long_lines = true
popup_trigger_key = "/"
ignore_self = true
log_actions = true
hide_bottom_input = true
agent_name_color = "#000000"
current_item_bg_color = "#4a4a4a"
sidebar_width = 60

# Display TODO from project files (TODO.md, etc.)
todo_from_file = true
todo_files = ["TODO.md", "NOTES.md", "TASKS.md", "README.md"]

[[agents]]
id = "claude"
name = "Claude"
background_color = "#fce4fc"
priority = 100
  default_status = "processing"
  
  [[agents.matchers]]
  type = "command"
  pattern = "(?i)claude|anthropic|claude-code"
  
  [[agents.matchers]]
  type = "ancestor"
  pattern = "(?i)claude|anthropic|claude-code"

  # 1. Structural Prompt Block (Synthesis/Contextual)
  # Recognizes the two lines with the prompt between them.
  # Determines state based on the indicator block ABOVE the separator.
  # NOTE: Layout stripping removes the footer region, so we match up to the prompt.
  [[agents.state_rules]]
  status = "idle" # Fallback is now IDLE because if we match the structure, we see a prompt.
  # Capture everything up to the separator as indicator. Handle optional │ in separators.
  # Support both solid (─) and dashed (╌) lines.
  # Support body capture and suffix (content after prompt, e.g. help text).
  # Use (?:^|\n) to robustly match line boundaries.
  # Use non-greedy indicator (.*?) to start from the top of the block.
  # Use [^\n]*❯ for prompt to prevent swallowing body lines.
  # Use [│]* instead of [│]? to handle multiple pipe characters (e.g. from tmux split panes).
  # Use non-greedy (?P<body>.*?) before the footer to correctly isolate the current active block.
  pattern = '''(?ms)(?P<indicator>.*?)(?:^|\n)[ \t]*[│]*[─╌]{10,}.*?(?:$|\n)(?P<body>.*?)(?:^|\n)[ \t]*[│]*[^\n]*❯(?P<suffix>.*)$'''
  
  # Refinement: Detect questions in the body to switch to awaiting_approval
  [[agents.state_rules.refinements]]
  group = "body"
  pattern = "(?i)Do you want to|wants to exit.*?mode|Exit.*?mode\\?|confirm"
  status = "awaiting_approval"
  [[agents.state_rules.refinements]]
  group = "indicator"
  pattern = '''(?is)(?:Mulling|Thinking|Esc to interrupt|✢|∴)[^\n]*(?:\n[^\n]*){0,3}\s*\z'''
  status = "processing"


  # 2. Specialized Approvals
  [[agents.state_rules]]
  status = "awaiting_approval"
  approval_type = "edit"
  pattern = '''(?i)(?:Edit|Write|Modify)\s+.*?\?|Do you want to (?:edit|write|modify)|Allow.*?edit'''

  [[agents.state_rules]]
  status = "awaiting_approval"
  approval_type = "create"
  pattern = '''(?i)Create\s+.*?\?|Do you want to create|Allow.*?create'''

  [[agents.state_rules]]
  status = "awaiting_approval"
  approval_type = "delete"
  pattern = '''(?i)Delete\s+.*?\?|Do you want to delete|Allow.*?delete'''

  [[agents.state_rules]]
  status = "awaiting_approval"
  approval_type = "shell"
  pattern = '''(?i)(?:Run|Execute)\s+(?:command|bash|shell)|Do you want to run|Allow.*?(?:command|bash)|run this command'''

  [[agents.state_rules]]
  status = "awaiting_approval"
  approval_type = "mcp"
  pattern = '''(?i)MCP\s+tool|Do you want to use.*?MCP|Allow.*?MCP'''

  [[agents.state_rules]]
  status = "awaiting_approval"
  pattern = '''(?ms)(?<details>Let me ask you.*?)(\n\s*Enter to select\s*[\n\r]*\z)'''

  # 3. Legacy Input Detection (Fallback)
  [[agents.state_rules]]
  status = "awaiting_input"
  pattern = '''(?s).*[❯]\s*\z'''
  
  # 4. Processing Indicators (Manual)
  [[agents.state_rules]]
  status = "processing"
  pattern = '''(?mx)
    (?:
      ^[ \t]*[✽⎿✻✢*∴]\s+.*   # Spinner or continuation (Added ✢, *, ∴)
      |
      (?:Mulling|Thinking)…
      |
      ^[ \t]*●\s+.*      # Tool use bullet
      |
      \(Esc\s+to\s+interrupt # Generic footer
    )
  '''

  [agents.subagent_rules]
  start = '''(?m)[⏺⠿⠇⠋⠙⠸⠴⠦⠧⠖⠏]\s*Task\s*\([^)]*subagent_type\s*[:=]\s*["']?(\w[\w-]*)["']?[^)]*description\s*[:=]\s*["']([^"']+)["']'''
  running = '''(?m)^[^│]*[▶►⠿⠇⠋⠙⠸⠴⠦⠧⠖⠏]\s*(\w+)(?:\s*agent)?:?\s*(.*)$'''
  complete = '''(?m)[✓✔]\s*(\w+).*?(?:completed|finished|done|returned)'''

  [agents.keys]
  approve = "y"
  reject = "n"

  # Support standard prompts: $, #, %, >, ❯
  pattern = '''(?s).*[$#%>❯]\s*\z'''

[[agents]]
id = "gemini"
name = "Gemini"
background_color = "#fcfce0"
priority = 90
  [[agents.matchers]]
  type = "command"
  pattern = "(?i)gemini|google"

  [[agents.state_rules]]
  status = "awaiting_input"
  pattern = '''(?s).*[>]\s*\z'''

[[agents]]
id = "opencode"
name = "OpenCode"
background_color = "#e6f3ff"
priority = 85
  [[agents.matchers]]
  type = "command"
  pattern = "(?i)opencode|open-code"

  [[agents.state_rules]]
  status = "awaiting_input"
  pattern = '''(?s).*[>]\s*\z'''

[[agents]]
id = "codex_cli"
name = "Codex"
background_color = "#eaffea"
priority = 80
  [[agents.matchers]]
  type = "command"
  pattern = "(?i)codex|openai"

  [[agents.state_rules]]
  status = "awaiting_input"
  pattern = '''(?s).*[>]\s*\z'''

[[agents]]
id = "generic_shell"
name = "shell"
background_color = "#eaffe3"
priority = 10
  # Default for Terminal: if no prompt is seen, it's busy (processing)
  default_status = "processing"

  [[agents.matchers]]
  type = "command"
  pattern = ".*"

  # Generic Shell State Rules: TUI Apps (mc, htop, etc.)
  [[agents.state_rules]]
  status = "tui:mc"
  last_lines = 3
  pattern = '''(?m)^ 1Help\s+2Menu\s+3View\s+4Edit\s+5Copy\s+6RenMov'''

  [[agents.state_rules]]
  status = "tui:htop"
  last_lines = 3
  pattern = '''(?m)^(?:F1| 1)Help\s+F?2Setup\s+F?3Search\s+F?4Filter\s+F?5'''

  [[agents.state_rules]]
  status = "tui:vim"
  last_lines = 3
  pattern = '''(?m)^-- (?:INSERT|VISUAL|REPLACE) --|\[[0-9]+\]\s+[0-9]+%\s+L:[0-9]+\s+C:[0-9]+'''

  [[agents.state_rules]]
  status = "tui:generic"
  last_lines = 3
  # Detect common frame characters used in TUIs (mc, dialog, etc.)
  pattern = '''[│┌┐└┘├┤┬┴┼═║╔╗╚╝╠╣╦╩╬]'''

  # Error State: Non-zero exit code in prompt (e.g. "1 x")
  [[agents.state_rules]]
  status = "error"
  last_lines = 300
  pattern = '''(?s).*\d+\s+x\s*\z'''

  # Generic Shell State Rules: ONLY the prompt makes it Idle
  [[agents.state_rules]]
  status = "idle"
  last_lines = 300
  # Support standard prompts: $, #, %, >, ❯
  pattern = '''(?s).*[$#%>❯]\s*\z'''

[key_bindings]
"j" = { navigate = "next_agent" }
"k" = { navigate = "prev_agent" }
"y" = "approve"
"Y" = "approve"
"n" = "reject"
"N" = "reject"
"a" = "approve_all"
"A" = "approve_all"
"E" = { send_keys = "Escape" }
"C" = { send_keys = "C-c" }
"D" = { send_keys = "C-d" }
"K" = { kill_app = { method = "sigterm" } }
"r" = "rename_session"
"C-l" = "refresh"
"C-s" = "capture_test_case"
"0" = { send_number = 0 }
"1" = { send_number = 1 }
"2" = { send_number = 2 }
"3" = { send_number = 3 }
"4" = { send_number = 4 }
"5" = { send_number = 5 }
"6" = { send_number = 6 }
"7" = { send_number = 7 }
"8" = { send_number = 8 }
"9" = { send_number = 9 }
"m" = "toggle_menu"
"s" = "toggle_subagent_log"
