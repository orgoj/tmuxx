# Session Diary

**Date**: 2026-01-25 14:35
**Session ID**: c1424eea-e4e0-4bd6-a295-0c10a64aaad0
**Project**: /home/michael/work/ai/TOOLS/tmuxcc

## Task Summary
User reported that the tmuxcc-wrapper.sh script was not working properly. When executed, it would create a tmux session but immediately fail to attach, showing "can't find session: tmuxcc" error. The goal was to diagnose the issue and fix the wrapper script.

## Work Done
- **Diagnosed wrapper script failure**: Analyzed debug output (`bash -x tcc`) to understand the failure point
- **Fixed session creation**: Modified `scripts/tmuxcc-wrapper.sh` to properly create and maintain tmuxcc session
  - Changed from direct tmuxcc execution to bash session + send-keys approach
  - Added full path resolution for tmuxcc binary to avoid PATH issues
  - Session now stays alive even if tmuxcc exits
- **Updated CHANGELOG.md**: Added Unreleased entry documenting the fix
- **Committed changes**: Two commits created
  - `56cf8cd`: fix: Correct tmuxcc-wrapper.sh session creation
  - `4f197c0`: docs: Add AGENTS.md and GEMINI.md documentation

## Design Decisions
- **Send-keys approach instead of direct execution**: The wrapper now creates a bash session first, then sends tmuxcc command via `tmux send-keys`. This ensures the session remains alive even if tmuxcc fails, allowing error inspection.
- **Full path resolution**: Using `command -v` to get the full path to tmuxcc binary prevents PATH issues inside tmux session (tmux may not have /home/michael/bin in PATH).

## Challenges & Solutions
| Challenge | Solution |
|-----------|----------|
| Session created but immediately dies | Create bash session instead of direct tmuxcc execution; use send-keys to launch tmuxcc |
| "can't find session" error on attach | Session was terminating because tmuxcc wasn't found in PATH or exited immediately |
| Initial wrong fix attempt | User corrected approach - use send-keys to bash, not shell command execution |

## Mistakes & Corrections

### Where I Made Errors:
- **First attempt was wrong**: I initially tried to fix by using `$TMUXCC_PATH; exec bash` as the session command. User corrected me that this should use send-keys approach instead.
- **Misunderstood the user's feedback initially**: When user showed me the debug output and said "videl jsi ten vystup", I initially missed that the session was being created but dying immediately. User had to point out that it fails at attach time, not creation time.

### What Caused the Mistakes:
- **Not carefully analyzing the debug output**: The output showed "tmux new-session" succeeded but "tmux attach" failed - this meant the session was created and then died, not that creation failed.
- **Wrong mental model**: I assumed direct execution in tmux session would work, but the correct pattern for interactive tools is: create shell session → send-keys to launch tool.

## Lessons Learned

### Technical Lessons:
- **tmux session lifecycle**: When a tmux session's command exits, the session terminates automatically. To keep session alive, use a long-running command like bash.
- **send-keys pattern for tmux automation**: The proper pattern for launching interactive tools in tmux is: `tmux new-session -d -s name bash` → `tmux send-keys -t name "command" Enter`
- **PATH differences in tmux**: tmux sessions may have different PATH than parent shell, so always use full paths when launching commands.

### Process Lessons:
- **Analyze debug output thoroughly**: When user provides `bash -x` output, trace through each command to understand what succeeds and what fails.
- **Listen to user corrections**: When user says specific approach (send-keys), follow it exactly rather than proposing alternatives.

### To Remember for CLAUDE.md:
- tmux wrapper scripts should use send-keys pattern, not direct command execution
- Always use full paths when launching binaries in tmux sessions

## Skills & Commands Used

### Used in this session:
- [x] Skill: `.claude/skills/tmuxcc-commit/SKILL.md` - Pre-commit workflow for tmuxcc project
- [ ] Other skills not used for this simple fix

### Feedback for Skills/Commands:
| File | Issue/Observation | Suggested Fix/Action |
|------|-------------------|----------------------|
| N/A | No issues | Skills worked as expected |

## User Preferences Observed

### Git & PR Preferences:
- **Commit message format**: Clear Problem/Solution/Changes structure with Co-Authored-By
- **CHANGELOG discipline**: Must update CHANGELOG.md before committing fixes
- **Selective staging**: Git reset specific files (AGENTS.md, GEMINI.md) to commit separately

### Code Quality Preferences:
- **Build verification**: `cargo build --release` before claiming done
- **Clippy required**: `cargo clippy` must pass with no warnings
- **Format required**: `cargo fmt` before commit

### Technical Preferences:
- **Send-keys pattern**: Prefer tmux send-keys over direct command execution for interactive tools
- **Session persistence**: Sessions should remain alive even if the main tool crashes

## Code Patterns Used
- **tmux wrapper pattern**:
  ```bash
  tmux new-session -d -s "$SESSION" bash
  tmux send-keys -t "$SESSION" "$FULL_PATH_TO_BINARY" Enter
  tmux attach-session -t "$SESSION"
  ```

## Notes
- The wrapper script (`~/bin/tcc`) is a symlink to `scripts/tmuxcc-wrapper.sh`
- User uses Czech in conversation but English in code/docs (per CLAUDE.md language rules)
- Debug mode (`bash -x`) was essential for diagnosing the issue
- User was direct and specific about corrections ("to je spatne, to ma poustet v tmux bash a tmuxcc az v nem pres sendkey")
