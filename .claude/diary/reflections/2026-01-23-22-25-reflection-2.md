# Reflection: Last 2 Entries

**Generated**: 2026-01-23 22:25
**Entries Analyzed**: 2
**Date Range**: 2026-01-23 19:50 to 2026-01-23 20:35

## Summary

This reflection analyzes two consecutive sessions focused on tmuxcc development. The first session implemented a comprehensive configurable key bindings system, while the second fixed a UI bug and refactored documentation by extracting workflows into skills.

Key insights: User demonstrates strong preference for discipline-driven development (write-first principles, pre-commit checklists). Multiple mistakes occurred when skipping documented procedures, highlighting the importance of explicit skill invocation. The sessions revealed patterns around dynamic UI generation, testing discipline, and documentation extraction strategies.

## Patterns Identified

### Strong Patterns (3+ occurrences across both entries)

1. **Pre-commit Checklist Enforcement** (2/2 entries)
   - Observation: Both sessions required CHANGELOG.md updates, README.md updates, cargo clippy/fmt before commit. Entry 2 showed violation when commit was attempted without checklist.
   - CLAUDE.md rule: `- Pre-commit: MANDATORY checklist - CHANGELOG.md, README.md, cargo clippy, cargo fmt, cargo build --release`

2. **User Provides Immediate, Specific Feedback** (2/2 entries)
   - Observation: User catches UX issues during runtime testing ("j/k se porad zobrazuje jako navigacni", "proc je Y / y..."), provides precise corrections with examples.
   - CLAUDE.md rule: `- User feedback: Runtime testing reveals UX issues code review misses - visual verification is CRITICAL`

3. **Documentation Extraction Pattern** (2/2 entries)
   - Observation: Entry 1 suggested creating "rust-ui-development" skill. Entry 2 extracted 4 workflows into skills (tmuxcc-testing, tmuxcc-commit, etc.), reducing CLAUDE.md from 468 to 285 lines.
   - CLAUDE.md rule: `- Documentation: Extract repetitive workflows into skills - keep CLAUDE.md under 300 lines`

### Emerging Patterns (2 occurrences)

1. **Dynamic UI from Config** (2/2 entries)
   - Observation: Entry 1 implemented dynamic help/footer from key_bindings. Entry 2 added dynamic preview trimming. Both focused on runtime-configurable UI.
   - CLAUDE.md rule: `- Ratatui UI: Prefer dynamic generation from config over hardcoded text - enables runtime customization`

2. **HashMap Ordering for UI Consistency** (2/2 entries)
   - Observation: Entry 1 fixed key sorting (lowercase before uppercase). Entry 2 emphasized checking all existing skills (HashMap iteration order issue).
   - CLAUDE.md rule: `- HashMap display: ALWAYS sort keys explicitly for consistent UI presentation - HashMap iteration order is non-deterministic`

3. **Testing Session Discipline** (2/2 entries)
   - Observation: Entry 1 used ct-test for testing. Entry 2 had 7 violations of testing rules (creating random sessions, wrong targets, batch send-keys).
   - CLAUDE.md rule: `- tmux testing: Use ONLY existing sessions, send keys ONE at a time to ct-test without window numbers`

### Rule Violations Detected

**Entry 2 violations of existing CLAUDE.md rules:**

1. **tmuxcc-testing skill NOT invoked before testing** (line 169: "INVOKE before testing!")
   - Violation: Attempted testing without reading skill
   - Action: Strengthen rule - make skill invocation MANDATORY with verification step

2. **tmuxcc-commit skill NOT invoked before commit** (line 174: "INVOKE before every commit!")
   - Violation: Proposed commit without checklist
   - Action: Strengthen rule - add reminder to check skill exists for task type

3. **Didn't search for existing skills before creating** (line 164 lists all skills)
   - Violation: Created 4 new skills without discovering existing `adding-config-option`
   - Action: Add explicit rule to search `.claude/skills/` before creating

## Proposed CLAUDE.md Updates

### Testing Guidelines Section (NEW)

```
### Testing Discipline

- **INVOKE tmuxcc-testing skill**: MANDATORY before ANY testing - contains session structure, send-keys rules, tmux safety
- **One key at a time**: Send ONE key, capture output, verify, then next - prevents destructive commands
- **ct-test is sacred**: ONLY send keys to ct-test session, NO window numbers
- **NEVER create random tmux sessions**: Use ONLY existing sessions (ct-test, cc-tmuxcc, etc.)
```

### Development Workflow Section (UPDATES)

Add before "Project-Specific Skills" section:

```
### Skill-First Development

- **Check skills BEFORE starting**: Search `.claude/skills/` for relevant skills before implementing
- **INVOKE skills matching task type**: Testing? → tmuxcc-testing. Commit? → tmuxcc-commit. Config? → adding-config-option
- **Create skills for repetitive workflows**: If explaining same process twice → create skill
```

### Common Pitfalls Section (ADDITIONS)

Add to existing list:

```
9. **HashMap Display Order**: HashMap iteration is non-deterministic - ALWAYS sort keys explicitly for UI consistency
10. **Trailing Content in UI**: When displaying "last N lines", trim trailing empty content first to ensure actual data is visible
11. **Skipping Skills**: Attempting tasks without invoking relevant skills leads to mistakes - check `.claude/skills/` first
12. **Batch Operations Without Verification**: Sending multiple commands at once can cause destructive failures - verify each step
```

## One-Off Observations

### From Entry 1:
- User prefers uppercase-only bindings (Y/N/A) for cleaner UX
- vim-like workflow: Remap j/k to send arrows to agent, use ↓/↑ for tmuxcc navigation
- config.example.toml in repo root follows standard Rust convention

### From Entry 2:
- User signals critical errors with "červené tlačítko" (red button) when frustrated
- META RULE #0 "WRITE FIRST, DO LATER" is now in tmuxcc-testing skill
- Flexible language markers (`_cs`, `.cs`, `-cs`) work better than rigid `.cs` extension

## Skills/Commands Updates Applied

### `.claude/skills/tmuxcc-testing.md` (Entry 2 - NEW)
- **Created**: Extracted testing workflow from CLAUDE.md
- **Content**: Test session structure, send-keys rules, tmux safety
- **Includes**: META RULE #0 "WRITE FIRST, DO LATER"

### `.claude/skills/tmuxcc-commit.md` (Entry 2 - NEW)
- **Created**: Extracted pre-commit checklist from CLAUDE.md
- **Content**: CHANGELOG.md updates, README.md updates, cargo build/clippy/fmt, commit message format

### `.claude/skills/tmuxcc-library-research.md` (Entry 2 - NEW)
- **Created**: Extracted library research workflow from CLAUDE.md
- **Content**: WebSearch for libraries, rtfmbro MCP for docs, Ratatui documentation

### `.claude/skills/tmuxcc-changelog.md` (Entry 2 - NEW)
- **Created**: Extracted TODO/CHANGELOG management workflow from CLAUDE.md
- **Content**: Move completed work from TODO.md to CHANGELOG.md

## Code Patterns Worth Standardizing

### 1. Trailing Content Trimming Pattern
```rust
// When displaying "last N lines", trim trailing empties first
let mut lines: Vec<&str> = content.lines().collect();
while lines.last().is_some_and(|l| l.trim().is_empty()) {
    lines.pop();
}
let start = lines.len().saturating_sub(display_count);
lines[start..].join("\n")
```

### 2. HashMap-Based Configuration with Dynamic UI
```rust
// Config storage
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct KeyBindings {
    #[serde(flatten)]
    pub bindings: HashMap<String, KeyAction>,
}

// Dynamic UI generation
for (key, action) in &config.key_bindings.bindings {
    // Generate UI elements from config
}

// CRITICAL: Sort keys for consistent display
keys.sort_by(|a, b| {
    match (a.chars().next(), b.chars().next()) {
        (Some(ac), Some(bc)) if ac.is_lowercase() && bc.is_uppercase() =>
            std::cmp::Ordering::Less,
        // ...
    }
});
```

### 3. Rust Borrow Checker Pattern for Temporary Values
```rust
// ❌ WRONG - temporary value dropped
let key = kb.keys_for_action(&KeyAction::Approve).first();

// ✅ CORRECT - intermediate binding extends lifetime
let approve_keys = kb.keys_for_action(&KeyAction::Approve);
let approve_key = approve_keys.first();
```

## Metadata

### Entries Analyzed:
- 2026-01-23-19-50-ed64ec25.md (Session ed64ec25 - Configurable key bindings system)
- 2026-01-23-20-35-87932ad5.md (Session 87932ad5 - Pane preview bug fix + doc refactoring)

### Statistics:
- Total sessions: 2
- Strong patterns: 3
- Emerging patterns: 3
- Rule violations: 3
- Skills created: 4 (from Entry 2)
- CLAUDE.md reduction: 468 → 285 lines (39%)
