# Session Diary

**Date**: 2026-01-24 12:01
**Session ID**: 9c0719cb-8223-4269-a831-5e2c701a4285
**Project**: /home/michael/work/ai/TOOLS/tmuxcc

## Task Summary
Implemented command execution feature for tmuxcc keybindings with variable expansion, enabling users to run shell commands (like opening editors) from keyboard shortcuts.

## Work Done
- Added `ExecuteCommand` variant to `KeyAction` and `Action` enums
- Implemented variable expansion: `${SESSION_NAME}`, `${SESSION_DIR}`, `${ENV:VAR}`
- Added `--debug-config` flag to show loaded config and bindings
- Fixed TOML parsing to reject unknown fields with `deny_unknown_fields`
- Added `set_status()` method to distinguish success (green âœ“) from errors (red âœ—)
- Fixed UTF-8 panic in footer widget (âœ“ is 3-byte multi-byte character)
- Created `tmuxcc-gemini-review` skill for AI code review workflow
- Updated README.md with correct TOML format (`execute_command = { command = "..." }`)

Files modified:
- `src/app/key_binding.rs` - ExecuteCommand variant, deny_unknown_fields, tests
- `src/app/actions.rs` - ExecuteCommand variant
- `src/app/config.rs` - Fixed load() to show errors instead of silently ignoring
- `src/app/config_override.rs` - Command parsing, rename_session/refresh support, key name preservation
- `src/app/state.rs` - Added set_status() method
- `src/ui/app.rs` - Command execution handler with variable expansion
- `src/ui/components/footer.rs` - Status/error distinction with UTF-8 fix
- `src/ui/components/help.rs` - Display command bindings in help
- `src/main.rs` - Added --debug-config flag
- `README.md` - Updated with correct TOML format
- `CHANGELOG.md` - Feature entry

## Design Decisions
- **TOML format**: Used `execute_command = { command = "..." }` instead of `command = "..."` because serde uses `rename_all = "snake_case"`
- **Error handling**: Changed Config::load() to panic on invalid config instead of silently ignoring - gives users immediate feedback
- **Status display**: Used âœ“ prefix with green color for success, âœ— with red for errors - clear visual distinction
- **CLI override format**: `command:CMD[:blocking]` uses `rsplit_once(':')` to handle colons in commands themselves
- **Variable expansion**: Simple string replacement for SESSION_NAME/DIR, regex for ${ENV:VAR}

## Challenges & Solutions

| Challenge | Solution |
|-----------|----------|
| Silent config parsing errors | Added `deny_unknown_fields` and removed `.ok()` in Config::load() |
| UTF-8 panic in footer (âœ“ is 3 bytes) | Used `chars().skip(2).collect()` instead of byte slicing |
| Commands not visible in help | Added ExecuteCommand loop in help.rs to display all command bindings |
| Can't see what command is running | Show expanded command with actual path instead of template variables |

## Mistakes & Corrections

### Where I Made Errors:
- **Tested serialization instead of actual config loading** - Unit tests passed but real config silently failed
- **Used `tail` with `tmux capture-pane`** - User corrected: this is unsafe, could show partial destructive commands
- **Forgot about multi-byte UTF-8 characters** - Used byte slicing `[2..]` on string with âœ“ (3 bytes) causing panic
- **Used `set_error()` for success messages** - Made success appear red (âœ—) instead of green (âœ“)

### What Caused the Mistakes:
- **Over-reliance on unit tests** - Didn't test actual TOML file parsing in runtime
- **Ignoring tmuxcc-testing skill rules** - Skipped safety rules for quick testing
- **UTF-8 oversight** - Forgot that checkmark is multi-byte character
- **Incomplete status display design** - Reused error path for success messages

## Lessons Learned

### Technical Lessons:
- **serde `deny_unknown_fields`** - Essential for catching config errors early, should be standard for user-facing config
- **TOML `rename_all = "snake_case"`** - Requires `field_name` instead of `fieldName` in TOML
- **UTF-8 in Rust** - Always use `chars()` for character indexing, never byte slicing
- **Multi-line command key bindings** - Use heredoc or escape newlines in bash -c ""

### Process Lessons:
- **Integration testing is critical** - Unit tests â‰  working config loading
- **User config testing** - Must test with actual ~/.config/tmuxcc/config.toml, not just in-memory
- **Safety first with tmux** - Always capture full pane output, never use tail/head
- **Test before claiming done** - Release build doesn't mean it works, runtime verification required

### To Remember for CLAUDE.md:
- **Always check if skills apply** - tmuxcc-testing, tmuxcc-commit skills exist and should be used
- **File reading discipline** - Use Read tool for files, never bash cat/head/tail
- **Command execution discipline** - One key at a time, verify result before next key
- **User feedback is critical** - "kurva jak ti mohli projit testy" - users notice when tests don't match reality

## Skills & Commands Used

### Used in this session:
- `tmuxcc-testing` - Testing workflow and tmux safety rules
- `tmuxcc-commit` - Pre-commit checklist (should use BEFORE committing)
- `tmuxcc-gemini-review` - Created new skill for AI code review workflow

### Feedback for Skills:
| File | Issue/Observation | Suggested Fix/Action |
|------|-------------------|----------------------|
| `tmuxcc-testing` | Working well | Keep using for all testing |
| `tmuxcc-commit` | Not used before commit | Add to workflow: invoke skill before every commit |
| N/A | Created `tmuxcc-gemini-review` skill | Test in next session before code review |

## User Preferences Observed

### Git & PR Preferences:
- Uses English for commits and code
- Wants clear error messages with file path and line numbers
- Testing required before claiming "done"

### Code Quality Preferences:
- `cargo clippy` warnings must be fixed
- `cargo fmt` required
- All tests must pass
- Runtime verification mandatory (not just unit tests)

### Technical Preferences:
- TOML config must reject invalid formats immediately
- Status/error distinction with colors (green/red)
- Show expanded commands, not templates
- Multi-byte UTF-8 characters must display correctly

## Code Patterns Used
- **Serde enum with variants**: `#[serde(rename_all = "snake_case")]` â†’ `field_name` in TOML
- **Config override parsing**: `rsplit_once(':')` for handling separators in commands
- **UTF-8 safe string slicing**: `s.chars().skip(n).collect::<String>()`
- **Status prefix pattern**: `âœ“ message` for success, plain message for errors

## Notes
- **Gemini CLI discovered** - `gemini review --file`, `git diff | gemini -p "prompt"`
- **Command execution feature complete** - Works with variable expansion, shows expanded paths
- **Panic example**: `byte index 2 is not a char boundary; it is inside 'âœ“' (bytes 0..3)`
- **Funny moment**: Pressed `v` key during testing, opened code on user's other desktop ðŸ˜„
