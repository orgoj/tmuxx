# Reflection: 2026-01-27 to 2026-01-28

**Generated**: 2026-01-28 17:15
**Entries Analyzed**: 6
**Date Range**: 2026-01-27 to 2026-01-28

## Summary
The last two days focused on stabilizing the AI agent monitoring engine and ensuring UI state persistence. The major breakthrough was the implementation of the **Structural Splitter Model**, which moved state detection from brittle line counts to robust UI-aware segmentation. This solved long-standing issues with terminal history leaking into current state detection. Another key focus was **Selection Persistence**, ensuring that user-selected agents remain selected even during tmux renames, agent restarts, or monitor refreshes.

## Patterns Identified

### Strong Patterns (3+ occurrences)
1. **The Structural Splitter Model** (4/6 entries)
   - Observation: Single-pass regex matching on raw buffers is too prone to history noise. Breaking the screen into "Body" and "Prompt" groups is the only way to scale.
   - CLAUDE.md rule: `- Agent detection: use the Structural Splitter Model to isolate current output from history.`

2. **Regex Anchoring (`\z`)** (3/6 entries)
   - Observation: Markers like `?` or `Done` appearing in scrollback caused frequent false positives. Using `\z` ensures we only care about the absolute end of the buffer.
   - CLAUDE.md rule: `- Status markers: MUST be anchored to the very end of the string (\z) to avoid history noise.`

3. **Persistent Selection via Fallbacks** (3/6 entries)
   - Observation: Unique IDs (Target+PID) are great but can change on restarts. Using a chain of Fallbacks (ID -> PID -> Target) keeps the UI cursor stable.
   - CLAUDE.md rule: `- Selection: must be persistent using the fallback chain: ID -> PID -> Target.`

4. **Structured Commit Format** (4/6 entries)
   - Observation: Standardized Problem/Solution/Changes blocks make the git history significantly easier to audit for regressions.
   - CLAUDE.md rule: `- git commits: use <type>: description followed by Problem/Solution/Changes blocks.`

5. **100% Test Pass Rate** (3/6 entries)
   - Observation: Any regression in agent detection is a high-priority failure. 100% pass rate is the only acceptable baseline for a commit.
   - CLAUDE.md rule: `- testing: 100% regression test pass rate is mandatory before committing.`

### Emerging Patterns (2 occurrences)
1. **Rule 0 Priority for Approvals** (2/6 entries)
   - Observation: Human interaction markers (TUI menus, question prompts) should preempt background task spinners to prevent blocking the user.
   - CLAUDE.md rule: `- Approvals: Rule 0 must always prioritize human interaction markers over background working indicators.`

2. **Config-ID for Storage** (2/6 entries)
   - Observation: Using display names for filesystem paths (fixtures, screenshots) is unstable. Stable config-ids should be used instead.
   - CLAUDE.md rule: `- Storage: use stable config IDs for file paths and directory names, never display names.`

## Rule Violations Detected
- **Breaking TUI detection**: Over-optimizing regex by removing literals (like "Approval Required") broke standard TUI menus.
  - Action: Strengthen rule: "Never remove legacy string literals from regexes unless verified across ALL fixtures."
- **Incomplete Context**: Reporting only partial failure data (footer only) when debugging.
  - Action: Strengthen rule: "Always read the last 20-40 lines of a fixture for context when reporting test failures."

## Proposed CLAUDE.md Updates

### Agent Status Detection
- Added "Structural Splitter Model" and "Regex Anchoring" guidelines.
- Formalized "Rule 0 Priority" for human interaction.

### Multi-Agent Selection
- Updated to reflect transition from `usize` (index) to `String` (ID) tracking.
- Added "Selection Persistence" fallback chain.

### Testing Discipline
- Explicitly mandated 100% pass rate.
- Added usage of `-d` flag for debugging.

## One-Off Observations
- Use of Braille range `[\u2800-\u28FF]` for robust spinner detection in Pi.
- Importance of `cargo check` as a baseline sanity check on legacy code.
- Managing `.git/index.lock` contention in automated environments.

## Metadata
- Entries analyzed:
  - 2026-01-27-19-42-FIX-AGENT-DETECTION.md
  - 2026-01-27-20-22-SESSION.md
  - 2026-01-27-21-30-FINAL-DETECTION-FIXES.md
  - 2026-01-27-21-55-SELECTION-FIX.md
  - 2026-01-27-22-05-SELECTION-PERSISTENCE.md
  - 2026-01-28-16-30-ROBUST-SELECTION.md
