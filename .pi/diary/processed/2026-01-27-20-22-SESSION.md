# Session Diary

**Date**: 2026-01-27 20:22
**Session ID**: 2026-01-27-20-22-SESSION
**Project**: /home/michael/work/ai/TOOLS/tmuxx

## Task Summary
Implement process indicators for agent environments (SSH/Docker/Nix) and stabilize agent state detection for Pi and Claude agents using a robust "Splitter Model" to avoid false positives from terminal history.

## Work Done
- **Process Indicators**: Added icons (üê≥, üåê, ‚ùÑ) to agent names in the tree view based on process ancestry detection.
- **Backend Infrastructure**: Added `ProcessTreeCache` to `src/tmux/pane.rs` for efficient `ps` tree walking.
- **Testing Improvements**: Added a `--debug` flag to `tmuxx test` that explains regex match results and shows extracted body/prompt content.
- **Agent Definitions**: 
    - Split `pi` agent into `pi` and `pi-powerline` to handle different statusbar styles.
    - Refactored `claude`, `pi`, and `pi-powerline` monitoring rules to use the "Splitter Pattern".
- **Bugfixes**: 
    - Fixed screenshot directory naming (now uses `config_id` instead of display name).
    - Moved orphaned test fixtures to the correct location.
- **New Skill**: Created `tmuxx-creating-agent-definition` to document the best practices for regex monitoring in this project.

## Design Decisions
- **The Splitter Model**: Instead of one giant regex, use a primary rule to split the buffer into `body` and `prompt/statusbar` groups, then use `refinements` on the clean body.
- **Config ID for Storage**: Switched from using display names (variable, contain spaces) to config IDs (stable, filesystem-safe) for test fixture management.
- **Precedence Overriding**: Forced `Approval` and `Error` refinements to take priority over `Working` to ensure critical states are never missed due to spinner matches.

## Challenges & Solutions
| Challenge | Solution |
|-----------|----------|
| False positives from terminal history | Used `last_lines` (3-15) and strict end-of-string anchoring (`\z`) in the Splitter rule. |
| Mixed TUI and Text prompts in Pi | Added `‚Üí Yes` detection alongside `?` at end of body. |
| Brittle regexes for Powerline | Explicitly konzumujeme specific unicode symbols (‚ï≠, ‚ï∞, ‚Üë, ‚îÄ) in the prompt regex. |

## Mistakes & Corrections
### Where I Made Errors:
- **Global Matching**: I initially wrote regexes without `\z`, causing them to match "Working..." or "Approval Required" strings anywhere in the scrollback buffer.
- **Regressions**: Fixing Pi detection accidentally broke Claude detection because I removed anchors from the shared logic.
- **Regex Grouping**: Made a common error where an `OR` branch was not properly grouped with the suffix constraints, making part of the rule match anywhere in the file.

### What Caused the Mistakes:
- Complexity of the Pi Powerline output compared to standard text terminals.
- Over-optimism about single-pass regex matching.

## Lessons Learned
### Technical Lessons:
- **Regex Flags**: In Rust, `(?m)` is a toggle. Use `(?m:...)` or careful ordering to avoid unintended side effects.
- **Efficiency**: Limiting regex searches to `last_lines=10` or `20` drastically improves reliability for TUI apps.

### Process Lessons:
- **Suite-wide testing**: Running the *full* test suite (`tmuxx test`) is mandatory after any change to `defaults.toml`, not just the suite currently being worked on.
- **Debugability**: Building tools to explain *why* a match happened (the `explain_status` method) is worth the initial effort.

## Skills Used

### Used in this session:
- [x] Skill: `tmuxx-working-on-todos` - Task selection.
- [x] Skill: `tmuxx-adding-new-features` - Process indicators implementation.
- [x] Skill: `tmuxx-managing-changelogs` - History tracking.
- [x] Skill: `tmuxx-committing-changes` - Pre-commit checks.
- [x] Skill: `creating-skills` - Created `tmuxx-creating-agent-definition`.
- [x] Skill: `selflearn-diary` - Documenting the session.

### Feedback for Skills:
*(Document issues found, improvements needed, or what worked well)*

| File | Issue/Observation | Suggested Fix/Action |
|------|-------------------|----------------------|
| `tmuxx-working-on-todos` | Worked perfectly for initial scoping. | No changes needed. |
| `selflearn-diary` | Crucial for capturing the "Splitter Model" breakthrough. | No changes needed. |

## User Preferences Observed
### Code Quality Preferences:
- 100% test pass rate is non-negotiable.
- Visual clarity in regexes is preferred (don't mix frames/UI with data).

### Technical Preferences:
- Prefer separate agent definitions over a single "one size fits all" complex regex.

## Code Patterns Used
- **Named Regex Groups**: `(?P<body>...)` and `(?P<prompt>...)` used for clean splitting.
- **Trait-based Explanations**: Extending `AgentParser` to support debugging.

## Notes
The session concluded with a significant improvement in the robustness of the monitoring engine. The "Splitter Model" is now the project standard.
