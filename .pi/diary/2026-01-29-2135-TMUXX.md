# Session Diary

**Date**: 2026-01-29 21:35
**Session ID**: 2026-01-29-2135-TMUXX
**Project**: /home/michael/work/ai/TOOLS/tmuxx

## Task Summary
Audit and refine the project's backlog (Dots) to ensure they are technically sound, precisely located in the codebase, and ready for autonomous implementation.

## Work Done
- Reviewed all open dots using `dot tree`, `dot ready`, and `dot show`.
- Performed deep code analysis across multiple modules:
  - `src/app/config.rs` (Config struct and highlighting rules)
  - `src/ui/components/pane_preview.rs` (Rendering logic and hardcoded highlighting)
  - `src/parsers/mod.rs` & `universal.rs` (Agent parsing and state detection)
  - `src/monitor/task.rs` (Background polling and updates)
  - `src/ui/app.rs` (Main UI loop and event handling)
- Refined the "Global Highlight Rules" task to move logic from UI components into the `UniversalParser` constructor and `defaults.toml`.
- Refined the "External TODO Generator" task to move execution from the UI loop to the `MonitorTask` background worker.
- Cleaned up the backlog by removing redundant info dots and replacing vague tasks with detailed technical specifications.

## Design Decisions
- **Parser-Centric Highlighting**: Decided to implement global highlight rules within `UniversalParser` rather than the UI. This ensures that highlighting logic is unified and the UI remains a "dumb" renderer.
- **Background TODO Refresh**: Chose to run the external TODO command in `MonitorTask` instead of `ui/app.rs`. This prevents any shell execution from blocking the TUI thread and fits the existing async update pattern.
- **Config-First Expansion**: Confirmed that the `Action Menu Variables` should reuse the existing `expand_command_variables` logic but requires a new `PopupType` to handle multi-step input collection.

## Challenges & Solutions
| Challenge | Solution |
|-----------|----------|
| Locating specific logic | Used `rg` and `grep` to trace the flow from `ui/app.rs` down to `UniversalParser`. |
| `dot info` vs `dot show` | Discovered `dot info` didn't provide the expected details; switched to `dot show`. |
| Hardcoded highlighting | Found specific fallback logic in `pane_preview.rs` that needs to be moved to `defaults.toml`. |

## Mistakes & Corrections
### Where I Made Errors:
- Used `grep` on a directory which failed.
- Initially assumed highlighting was purely a UI concern, but realized it's better handled at the parser level after reading `UniversalParser` implementation.

### What Caused the Mistakes:
- Habitual use of `grep` without checking if it's aliased or supports recursive directory search in the environment (should have used `rg` immediately).

## Lessons Learned
### Technical Lessons:
- `tmuxx` uses a "prompt sandwich" detection strategy (splitting content by separator lines) which is key for accurate AI state monitoring.
- The `MonitorUpdate` channel is the primary way to sync background state changes to the UI.

### Process Lessons:
- Deep analysis of the codebase *before* finalizing a "Dot" description is crucial for providing the "Worker" with a clear path.

### To Remember for CLAUDE.md:
- (Already documented, but reinforced): Always prefer `rg` over `grep` for searching the repository.
- `dot-manager` role requires checking both `src/app/state.rs` and `src/monitor/task.rs` for any new background functionality.

## Skills Used

### Used in this session:
- [x] Skill: `dot-manager` - Refined and validated the project backlog.
- [x] Skill: `selflearn-diary` - Created this session record.

### Feedback for Skills:
| File | Issue/Observation | Suggested Fix/Action |
|------|-------------------|----------------------|
| `dot-manager` | Works well for enforcing technical rigor. | N/A |

## User Preferences Observed
- Prefers highly detailed "Dots" with line numbers and architectural decisions pre-made.
- Prefers clean, modular code (moving logic out of UI components).

## Code Patterns Used
- **Monitor-Update Pattern**: Using `MonitorTask` to poll/execute and sending results via `mpsc` to the UI loop.
- **Universal Parser Extension**: Adding new rules/matchers to the `UniversalParser` instead of creating specialized parsers for every small feature.
